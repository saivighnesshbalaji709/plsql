<!-- GSCC_Category="Xdo Data Definition" -->
<dataTemplate name="XXOAOTLMISSPUNTIME"  version="1.0">
<properties>
  <property name="xml_tag_case" value="UPPER"/>
  <property name="debug_mode"   value="ON"/>
</properties>
<parameters>
	<parameter name="P_SBU"  			dataType = "VARCHAR"></parameter>
	<parameter name="P_DEPT"  			dataType = "VARCHAR"></parameter>
	<parameter name="P_SECT"  			dataType = "VARCHAR"></parameter>
	<parameter name="P_STATUS"  		dataType = "VARCHAR"></parameter>		
	<parameter name="P_TK_GROUP_ID"		dataType = "NUMBER"></parameter>
	<parameter name="P_PERSON_ID"		dataType = "NUMBER"></parameter>
	<parameter name="P_START_DATE"		dataType = "DATE"></parameter>
	<parameter name="P_END_DATE"		dataType = "DATE"></parameter>
</parameters>

<dataQuery>
<sqlStatement name="Q_MAIN2">
<![CDATA[
	select replace(','||to_char(sysdate,'DD-MON-YYYY HH24:MM:SS'),',','"') sdate from dual
]]>
</sqlStatement>

<sqlStatement name="Q_MAIN4">
<![CDATA[
	select TO_CHAR(:P_START_DATE,'DD-MON-RRRR') PS_date,TO_CHAR(:P_END_DATE,'DD-MON-RRRR') PE_date  from dual
]]>
</sqlStatement>
<sqlStatement name="Q_MAIN3">
<![CDATA[
	SELECT hr_general.decode_organization (:P_SBU) pm_sbu,
       hr_general.decode_organization (:P_DEPT) pm_dept,
       hr_general.decode_organization (:P_SECT) pm_sect
  FROM DUAL
]]>
</sqlStatement>
<sqlStatement name="Q_MAIN5">
<![CDATA[
	SELECT employee_number EMPP
  FROM --per_all_people_f ppf --Commented for (SR-186049)OTL Separation 
         per_people_f ppf     --Added for (SR-186049)OTL Separation  
 WHERE person_id = :P_PERSON_ID
       AND TRUNC (SYSDATE) BETWEEN ppf.effective_start_date
                               AND ppf.effective_end_date
]]>
</sqlStatement>
<sqlStatement name="Q_MAIN6">
<![CDATA[
	select tkg.TK_GROUP_NAME PM_GROUP
from --per_all_people_f p  --Commented for (SR-186049)OTL Separation
       per_people_f p	   --Added for (SR-186049)OTL Separation  	
	, hxc_tk_groups tkg
WHERE tkg.tk_resource_id = p.person_id
and trunc(sysdate) between p.effective_start_date and p.effective_end_date
AND tkg.tk_group_id=:P_TK_GROUP_ID
]]>
</sqlStatement>

<sqlStatement name="Q_MAIN">
<![CDATA[
SELECT   /*+INDEX_FFS(hxt_add_assign_info_f)*/
         person_id, emp_number, emp_name, sbu, department, section, job,
         POSITION, grade,  punch_date,TO_CHAR(punch_date,'DD-MON-RRRR') PUN_DATE, shift_name, shift_in, shift_out,
         time_in, time_out,
		 (SELECT lpad(time_hours,2,'0') ||':'|| lpad(nvl(time_minutes,0),2,'0') 
             FROM xxoa_otl_time_entry_stg xxot
               WHERE 1=1
               AND NVL(xxot.otl_int_status,'N') NOT IN ('E')
               AND xxot.trans_mode=1
               AND TRIM(xxot.emp_no)=EMP_NUMBER
              AND TRUNC(xxot.trans_date) =TRUNC(PUNCH_DATE)
			  AND ROWNUM=1) ACTUAL_PUNTCH_IN,
		 leave,
         CASE
            WHEN tot_hour > 0
               THEN    TO_CHAR (TRUNC ((tot_hour * 3600) / 3600),
                                'FM9900'
                               )
                    || ':'
                    || TO_CHAR (TRUNC (MOD ((tot_hour * 3600), 3600) / 60),
                                'FM00'
                               )
         END tot_hour,
         time_in_status, time_out_status,
         CASE
            WHEN extra_hour > 0
               THEN    TO_CHAR (TRUNC ((extra_hour * 3600) / 3600),
                                'FM9900'
                               )
                    || ':'
                    || TO_CHAR (TRUNC (MOD ((extra_hour * 3600), 3600) / 60),
                                'FM00'
                               )
         END extra_hour
    FROM (SELECT person_id, emp_number, emp_name, sbu, department, section,
                 job, POSITION, grade, punch_date, shift_name,
                 standard_start shift_in, standard_stop shift_out,
                 NVL (LPAD (TO_CHAR (timedate_in, 'HH24:MI'), '5', '0'),
                      0
                     ) time_in,
                 NVL (LPAD (TO_CHAR (timedate_out, 'HH24:MI'), '5', '0'),
                      0
                     ) time_out,
                 leave, tot_hour,
--                 CASE
--                    WHEN leave = 'REGULAR DAY'
--                       THEN CASE
--                              WHEN standard_start =
--                                     NVL
--                                        (LPAD (TO_CHAR (timedate_in,
--                                                        'HH24:MI'),
--                                               '5',
--                                               '0'
--                                              ),
--                                         0
--                                        )
--                                 THEN 'ON TIME'
--                              WHEN standard_start >
--                                     NVL (LPAD (TO_CHAR (timedate_in,
--                                                         'HH24:MI'
--                                                        ),
--                                                '5',
--                                                '0'
--                                               ),
--                                          0
--                                         )
--                                 THEN 'EARLY'
--                              ELSE CASE
--                              WHEN (  TO_DATE (standard_start, 'HH24:MI')
--                                    + (  (xxoa_hr_late_early_ded_new.late_coming_grace_time
--                                         )
--                                       * (1 / 24 / 60)
--                                      )
--                                   ) <
--                                     TO_DATE
--                                          (NVL (LPAD (TO_CHAR (timedate_in,
--                                                               'HH24:MI'
--                                                              ),
--                                                      '5',
--                                                      '0'
--                                                     ),
--                                                0
--                                               ),
--                                           'HH24:MI'
--                                          )
--                                 THEN 'LATE'
--                              ELSE 'GRACE TIME'
--                           END
--                           END
--                 END time_in_status,
--                 CASE
--                    WHEN leave = 'REGULAR DAY'
--                       THEN CASE
--                              WHEN standard_stop <
--                                     NVL
--                                        (LPAD (TO_CHAR (timedate_out,
--                                                        'HH24:MI'
--                                                       ),
--                                               '5',
--                                               '0'
--                                              ),
--                                         0
--                                        )
--                                 THEN 'LATE'
--                              WHEN standard_stop =
--                                     NVL (LPAD (TO_CHAR (timedate_out,
--                                                         'HH24:MI'
--                                                        ),
--                                                '5',
--                                                '0'
--                                               ),
--                                          0
--                                         )
--                                 THEN 'ON TIME'
--                              ELSE CASE
--                              WHEN (  TO_DATE (standard_stop, 'HH24:MI')
--                                    - (  (xxoa_hr_late_early_ded_new.early_going_grace_time
--                                         )
--                                       * (1 / 24 / 60)
--                                      )
--                                   ) >
--                                     TO_DATE
--                                         (NVL (LPAD (TO_CHAR (timedate_out,
--                                                              'HH24:MI'
--                                                             ),
--                                                     '5',
--                                                     '0'
--                                                    ),
--                                               0
--                                              ),
--                                          'HH24:MI'
--                                         )
--                                 THEN 'EARLY'
--                              ELSE 'GRACE TIME'
--                           END
--                           END
--                 END time_out_status,
 CASE
                      WHEN leave = 'REGULAR DAY'
                         THEN CASE
                                WHEN standard_start_time_stamp =
                                                   timedate_in
                                   THEN 'ON TIME'
                                WHEN standard_start_time_stamp >
                                                   timedate_in
                                   THEN 'EARLY'
                                ELSE CASE
                                WHEN (  standard_start_time_stamp
                                      + (  (xxoa_hr_late_early_ded_new.late_coming_grace_time
                                           )
                                         * (1 / 24 / 60)
                                        )
                                     ) < timedate_in
                                   THEN 'LATE'
                                ELSE 'GRACE TIME'
                             END
                             END
                   END time_in_status,
                   CASE
                      WHEN leave = 'REGULAR DAY'
                         THEN CASE
                                WHEN standard_stop_time_stamp <
                                                 timedate_out
                                   THEN 'LATE'
                                WHEN standard_stop_time_stamp =
                                                 timedate_out
                                   THEN 'ON TIME'
                                ELSE CASE
                                WHEN (  standard_stop_time_stamp
                                      - (  (xxoa_hr_late_early_ded_new.early_going_grace_time
                                           )
                                         * (1 / 24 / 60)
                                        )
                                     ) > timedate_out
                                   THEN 'EARLY'
                                ELSE 'GRACE TIME'
                             END
                             END
                   END time_out_status,
                 CASE
                    WHEN leave = 'REGULAR DAY'
                       THEN   CASE
                                 WHEN timedate_out < timedate_in
                                    THEN   24
                                         * ((timedate_out + 1) - timedate_in
                                           )
                                 ELSE 24 * (timedate_out - timedate_in)
                              END
                            - CASE
                                 WHEN standard_stop < standard_start
                                    THEN   24
                                         * (  (  TO_DATE (standard_stop,
                                                          'HH24:MI'
                                                         )
                                               + 1
                                              )
                                            - TO_DATE (standard_start,
                                                       'HH24:MI'
                                                      )
                                           )
                                 ELSE   24
                                      * (  TO_DATE (standard_stop, 'HH24:MI')
                                         - TO_DATE (standard_start, 'HH24:MI')
                                        )
                              END
                 END extra_hour
            FROM (SELECT papf.person_id, papf.employee_number emp_number,
                         papf.full_name emp_name,
                         NVL
                            (xxoa_hr.get_parent_org
                                  (fnd_profile.VALUE ('PER_BUSINESS_GROUP_ID'),
                                   paaf.organization_id,
                                   'SBU',
                                   'NAME'
                                  ),
                             xxoa_hr.get_parent_org
                                  (fnd_profile.VALUE ('PER_BUSINESS_GROUP_ID'),
                                   paaf.organization_id,
                                   'SU',
                                   'NAME'
                                  )
                            ) sbu,
                         xxoa_hr.get_parent_org
                            (fnd_profile.VALUE ('PER_BUSINESS_GROUP_ID'),
                             paaf.organization_id,
                             'DEPT',
                             'NAME'
                            ) department,
                         xxoa_hr.get_parent_org
                            (fnd_profile.VALUE ('PER_BUSINESS_GROUP_ID'),
                             paaf.organization_id,
                             'SE',
                             'NAME'
                            ) section,
                         pj.NAME job, pap.NAME POSITION, pg.NAME grade,
                         bcd.calendar_date punch_date, hs.NAME shift_name,
                         TO_CHAR
                            (TO_DATE (TO_CHAR (hs.standard_start, '0000'),
                                      'HH24MI'
                                     ),
                             'HH24:MI'
                            ) standard_start,
                         TO_CHAR
                            (TO_DATE (TO_CHAR (hs.standard_stop, '0000'),
                                      'HH24MI'
                                     ),
                             'HH24:MI'
                            ) standard_stop,
                             TO_DATE
                              (   TO_CHAR (DECODE(hs.standard_start,'0',(bcd.calendar_date+1),bcd.calendar_date), 'DD-MON-RRRR')
                               || ' '
                               || TO_CHAR
                                       (TO_DATE (TO_CHAR (hs.standard_start,
                                                          '0000'
                                                         ),
                                                 'HH24MI'
                                                ),
                                        'HH24:MI'
                                       ),
                               'DD-MON-RRRR HH24:MI'
                              ) standard_start_time_stamp,
                          TO_DATE
                              (   TO_CHAR (CASE WHEN hs.standard_start='0' THEN (bcd.calendar_date+1)
                                                WHEN  TO_CHAR
                            (TO_DATE (TO_CHAR (hs.standard_stop, '0000'),
                                      'HH24MI'
                                     ),
                             'HH24:MI'
                            ) < TO_CHAR
                            (TO_DATE (TO_CHAR (hs.standard_start, '0000'),
                                      'HH24MI'
                                     ),
                             'HH24:MI'
                            )  THEN (bcd.calendar_date+1)
                              ELSE 
                              bcd.calendar_date END, 'DD-MON-RRRR')
                               || ' '
                               || TO_CHAR
                                        (TO_DATE (TO_CHAR (hs.standard_stop,
                                                           '0000'
                                                          ),
                                                  'HH24MI'
                                                 ),
                                         'HH24:MI'
                                        ),
                               'DD-MON-RRRR HH24:MI'
                              ) standard_stop_time_stamp,
                         xxoa_otl_actualtime_fns
                                              (bcd.calendar_date,
                                               papf.person_id,
                                               'START_TIME'
                                              ) timedate_in,
                         xxoa_otl_actualtime_fns
                                             (bcd.calendar_date,
                                              papf.person_id,
                                              'STOP_TIME'
                                             ) timedate_out,
                         xxoa_hr_get_leave_opt_fns
                                                 (bcd.calendar_date,
                                                  papf.person_id,
                                                  haaif.earning_policy,
                                                  hs.NAME
                                                 ) leave,
                         xxoa_otl_get_tothr_fns (bcd.calendar_date,
                                                 papf.person_id
                                                ) tot_hour
                    FROM --per_all_people_f papf,        --Commented for (SR-186049)OTL Separation
                         --per_all_assignments_f paaf,   --Commented for (SR-186049)OTL Separation
						 per_people_f papf,              --Added for (SR-186049)OTL Separation        
                         per_assignments_f paaf,		 --Added for (SR-186049)OTL Separation        				 
                         per_jobs pj,
                         per_all_positions pap,
                         per_grades pg,
                         hr_all_organization_units hou,
                         per_periods_of_service pos,
                         hxt_add_assign_info_f haaif,
                         hxt_rotation_plans hrp,
                         hxt_rotation_schedules hrs,
                         hxt_work_shifts hws,
                         xxoa_hr_calendar_v bcd,
                         hxt_shifts hs
                   WHERE 1 = 1
                     AND papf.person_id = NVL (:p_person_id, papf.person_id)
                     AND papf.person_id = paaf.person_id
                     AND papf.business_group_id = paaf.business_group_id
                     AND paaf.primary_flag = 'Y'
                     AND paaf.period_of_service_id = pos.period_of_service_id
                     AND paaf.business_group_id = pos.business_group_id
                     AND paaf.person_id = pos.person_id
                     AND paaf.assignment_id = haaif.assignment_id
                     AND paaf.job_id = pj.job_id(+)
                     AND paaf.position_id = pap.position_id(+)
                     AND pg.grade_id(+) = paaf.grade_id
                     AND hou.organization_id = paaf.organization_id
                     AND haaif.rotation_plan = hrp.ID
                     AND hrp.ID = hrs.rtp_id
                     AND hrs.start_date =
                            (SELECT MAX (hrs_s.start_date)
                               FROM hxt_rotation_schedules hrs_s
                              WHERE 1 = 1
                                AND hrs_s.start_date <=
                                                     TRUNC (bcd.calendar_date)
                                AND hrs_s.rtp_id = hrs.rtp_id)
                     AND hrs.tws_id = hws.tws_id
                     AND hws.week_day =
                            UPPER (SUBSTR (TO_CHAR (bcd.calendar_date, 'day'),
                                           1,
                                           3
                                          )
                                  )
                     AND hws.sht_id = hs.ID
                     AND papf.business_group_id =
                                   fnd_profile.VALUE ('PER_BUSINESS_GROUP_ID')
                     AND TRUNC (bcd.calendar_date)
                            BETWEEN papf.effective_start_date
                                AND papf.effective_end_date
                     AND TRUNC (bcd.calendar_date)
                            BETWEEN paaf.effective_start_date
                                AND paaf.effective_end_date
                     AND TRUNC (bcd.calendar_date) BETWEEN pos.date_start
                                                       AND NVL
                                                             (pos.actual_termination_date,
                                                              bcd.calendar_date
                                                             )
                     AND TRUNC (bcd.calendar_date)
                            BETWEEN haaif.effective_start_date
                                AND haaif.effective_end_date
                     AND TRUNC (bcd.calendar_date)
                            BETWEEN hs.effective_start_date
                                AND hs.effective_end_date
                     AND hs.standard_start IS NOT NULL
                     AND hs.standard_stop IS NOT NULL
                     AND TRUNC (bcd.calendar_date) BETWEEN :p_start_date
                                                       AND :p_end_date
                     AND EXISTS (
                            SELECT 1
                              FROM hxc_tk_group_queries htgq,
                                   hxc_tk_group_query_criteria htgqc
                             WHERE 1 = 1
                               AND htgqc.criteria_type = 'PERSON'
                               AND htgq.tk_group_id =
                                        NVL (:p_tk_group_id, htgq.tk_group_id)
                               AND htgq.tk_group_query_id =
                                                       htgqc.tk_group_query_id
                               AND htgqc.criteria_id = paaf.person_id)
                     AND (   (    :p_sect IS NULL
                              AND :p_dept IS NULL
                              AND :p_sbu IS NULL
                             )
                          OR (EXISTS (
                                 SELECT     organization_id_child
                                       FROM per_org_structure_elements str,
                                            per_organization_structures pos
                                      WHERE organization_id_child =
                                                          paaf.organization_id
                                        AND str.org_structure_version_id =
                                                 pos.organization_structure_id
                                        AND primary_structure_flag = 'Y'
                                        AND str.business_group_id =
                                               fnd_profile.VALUE
                                                      ('PER_BUSINESS_GROUP_ID')
                                 CONNECT BY str.organization_id_parent =
                                                PRIOR str.organization_id_child
                                 START WITH str.organization_id_child =
                                               NVL
                                                  ((SELECT organization_id
                                                      FROM hr_all_organization_units
                                                     WHERE organization_id =
                                                              NVL
                                                                 (NVL
                                                                     (:p_sect,
                                                                      :p_dept
                                                                     ),
                                                                  :p_sbu
                                                                 )),
                                                   paaf.organization_id
                                                  ))
                             )
                         )))
ORDER BY 4, 5, 6, 1, 10 
]]>
</sqlStatement>
</dataQuery>
  <dataStructure>
  <group name="G_MAIN2" source="Q_MAIN2">
		<element name="SDATE"				datatype="DATE"		value="sdate"/>			
	</group>
	<group name="G_MAIN3" source="Q_MAIN3">
		<element name="PM_SBU"				datatype="VARCHAR2"		value="PM_SBU"/>
		<element name="PM_DEPT"				datatype="VARCHAR2"		value="PM_DEPT"/>
		<element name="PM_SECT"				datatype="VARCHAR2"		value="PM_SECT"/>
	</group>
	<group name="G_MAIN4" source="Q_MAIN4">
		<element name="PS_date"				datatype="DATE"		value="PS_date"/>			
		<element name="PE_date"				datatype="DATE"		value="PE_date"/>
	</group>
	<group name="G_MAIN5" source="Q_MAIN5">
		<element name="EMPP"				datatype="VARCHAR2"		value="EMPP"/>			
	</group>
	<group name="G_MAIN6" source="Q_MAIN6">
		<element name="PM_GROUP"				datatype="VARCHAR2"		value="PM_GROUP"/>
	</group>
	<group name="G_MAIN" source="Q_MAIN">
					    <element name="SBU"					datatype="VARCHAR2"		value="SBU"/>		
	  					<element name="DEPARTMENT"			datatype="VARCHAR2"		value="DEPARTMENT"/>
						<element name="SECTION"			    datatype="VARCHAR2"		value="SECTION"/>		    
			<group name="G_DET_THREE" source="Q_MAIN">	
					<element name="EMP_NUMBER"			datatype="VARCHAR2"		value="EMP_NUMBER"/>
					<element name="EMP_NAME"			datatype="VARCHAR2"		value="EMP_NAME"/>	
				<group name="G_DET_FOUR" source="Q_MAIN">
					<element name="PUN_DATE"			datatype="VARCHAR2"		value="PUN_DATE"/>						
					<element name="JOB"					datatype="VARCHAR2"		value="JOB"/>	
					<element name="POSITION"			datatype="VARCHAR2"		value="POSITION"/>	
					<element name="GRADE"			    datatype="VARCHAR2"		value="GRADE"/>	
					<element name="SHIFT_NAME"			datatype="VARCHAR2"		value="SHIFT_NAME"/>
					<element name="LEAVE"			    datatype="VARCHAR2"		value="LEAVE"/>
					<element name="SHIFT_IN"			datatype="VARCHAR2"		value="SHIFT_IN"/>	
					<element name="SHIFT_OUT"			datatype="VARCHAR2"		value="SHIFT_OUT"/>	
					<element name="TIME_IN"			    datatype="VARCHAR2"		value="TIME_IN"/>	
					<element name="TIME_OUT"			datatype="VARCHAR2"		value="TIME_OUT"/>
					<element name="ACTUAL_PUNTCH_IN"			datatype="VARCHAR2"		value="ACTUAL_PUNTCH_IN"/>
					<element name="TIME_IN_STATUS"		datatype="VARCHAR2"		value="TIME_IN_STATUS"/>
					<element name="TIME_OUT_STATUS"		datatype="VARCHAR2"		value="TIME_OUT_STATUS"/>
					<element name="TOT_HOUR"			datatype="NUMBER"		value="TOT_HOUR"/>
					<element name="EXTRA_HOUR"			datatype="NUMBER"		value="EXTRA_HOUR"/>
				</group>
			</group>
		</group>
	</dataStructure>
</dataTemplate>
