SELECT 
  papf.employee_number 
, papf.title cont_emp_tit
, papf.full_name 
, xx.absent_date
, fu.email_address emp_email
,CASE
WHEN 
(
  select b.employee_number 
  from per_all_people_f b
  where person_id = paaf.supervisor_id 
    and b.CURRENT_EMPLOYEE_FLAG='Y' 
    and trunc(sysdate) between trunc(b.effective_start_date) and trunc(b.effective_end_date)
) = 
(
  select lookup_code 
  from fnd_lookups 
  where lookup_type='XXOA_SUP_MGR_EMAIL_EXCLUDE'  and enabled_flag='Y'
)
THEN 
(
  select email_address 
  from per_all_people_f C 
  where employee_number = (
    select A.description 
    from fnd_lookups A, per_all_people_f B 
    where B.person_id = paaf.supervisor_id 
      and trunc(sysdate) between trunc(B.effective_start_date) and trunc(B.effective_end_date) 
      and B.CURRENT_EMPLOYEE_FLAG='Y' 
      and A.lookup_type='XXOA_SUP_MGR_EMAIL_EXCLUDE' 
      and A.enabled_flag='Y'
  )
  and trunc(C.effective_start_date) <= trunc(sysdate) 
  and trunc(C.effective_end_date) >= trunc(sysdate) 
  and C.CURRENT_EMPLOYEE_FLAG='Y'
)
ELSE
(
  SELECT email_address 
  FROM apps.fnd_user 
  WHERE employee_id = paaf.supervisor_id
)
END as manager_email 
---(SELECT email_address FROM apps.fnd_user where employee_id = paaf.supervisor_id) manager_email
--, (SELECT email_address FROM apps.fnd_user where employee_id=paaf.ass_attribute8) req_emp_email
,CASE
WHEN 
(
  select b.employee_number 
  from per_all_people_f b
  where person_id = paaf.ass_attribute8 
    and b.CURRENT_EMPLOYEE_FLAG='Y' 
    and trunc(sysdate) between trunc(b.effective_start_date) and trunc(b.effective_end_date)
) = 
(
  select lookup_code 
  from fnd_lookups 
  where lookup_type='XXOA_SUP_MGR_EMAIL_EXCLUDE'  and enabled_flag='Y'
)
THEN 
(
  select email_address 
  from per_all_people_f C 
  where employee_number = (
    select A.description 
    from fnd_lookups A, per_all_people_f B 
    where B.person_id = paaf.supervisor_id 
      and trunc(sysdate) between trunc(B.effective_start_date) and trunc(B.effective_end_date) 
      and B.CURRENT_EMPLOYEE_FLAG='Y' 
      and A.lookup_type='XXOA_SUP_MGR_EMAIL_EXCLUDE' 
      and A.enabled_flag='Y'
  )
  and trunc(C.effective_start_date) <= trunc(sysdate) 
  and trunc(C.effective_end_date) >= trunc(sysdate) 
  and C.CURRENT_EMPLOYEE_FLAG='Y'
)
ELSE
(
  SELECT email_address 
  FROM apps.fnd_user 
  WHERE employee_id = paaf.supervisor_id
)
END as req_emp_email 
, (SELECT email_address FROM apps.fnd_user where employee_id= (select apps.xxoa_hr.get_hod(paaf.organization_id,TRUNC(sysdate),'ID') from dual)) hod

INTO
	&v_cont_emp
   ,&v_cont_emp_tit
   ,&v_cont_emp_name
   ,&v_absent_date
   ,&v_emp_email
   ,&v_mgr_email
   ,&v_req_emp_email
   ,&v_hod
FROM  
	xxoa_abs_suspend_assignment xx,
	apps.per_all_people_f papf,
	apps.per_all_assignments_f paaf, 
   	apps.hr_all_organization_units hou,
	apps.fnd_user fu,
   	apps.pay_all_payrolls_f ppf,
    (SELECT TO_NUMBER(global_value) no_of_days
		FROM   apps.ff_globals_f fgf
		WHERE  fgf.global_name = 'OA_EMP_ABS_FIRST_ALERT_RUN_DAYS'
		AND    TRUNC(SYSDATE) BETWEEN fgf.effective_start_date AND fgf.effective_end_date
		AND    fgf.business_group_id = 81) glb_days  
WHERE 1 = 1
AND papf.person_id = xx.person_id
AND papf.person_id = paaf.person_id
AND trunc(sysdate) BETWEEN papf.effective_start_date AND papf.effective_end_date
AND trunc(sysdate) BETWEEN paaf.effective_start_date AND paaf.effective_end_date
AND papf.current_employee_flag = 'Y'
AND paaf.primary_flag = 'Y'
AND paaf.assignment_type = 'E'
AND paaf.payroll_id = ppf.payroll_id
AND paaf.organization_id=hou.organization_id
AND fu.employee_id=papf.person_id
AND fu.user_name=papf.employee_number
AND paaf.payroll_id = 341
AND xx.ABSENT_DAYS = glb_days.no_of_days
