SELECT
    PPF.EMPLOYEE_NUMBER,
    PPF.PERSON_ID,
    INITCAP(PPF.FULL_NAME) FULL_NAME,
    TO_CHAR(PPF.START_DATE, 'DD-MON-YYYY') DOJ,
    PPS.NAME POSITION,
    PG.NAME GRADE,
 
    xxoa_hr.GET_PARENT_ORG(
        fnd_profile.VALUE('PER_BUSINESS_GROUP_ID'),
        paf.organization_id,
        'DEPT',
        'NAME'
    ) dept,
 
    xxoa_hr.GET_PARENT_ORG(
        fnd_profile.VALUE('PER_BUSINESS_GROUP_ID'),
        paf.organization_id,
        'SE',
        'NAME'
    ) section,
 
    TO_CHAR(:p_effective_start_date, 'DD-MON-YYYY') ps_date,
 
    TO_CHAR(PPF.DATE_OF_BIRTH, 'DD-MON-YYYY') DOB,
 
    CASE
        WHEN PPF.DATE_OF_BIRTH IS NOT NULL THEN
            TRUNC(MONTHS_BETWEEN(:p_effective_start_date, PPF.DATE_OF_BIRTH) / 12)
            || ' Years '
            || TRUNC(MOD(MONTHS_BETWEEN(:p_effective_start_date, PPF.DATE_OF_BIRTH), 12))
            || ' Months '
            || TRUNC(
                :p_effective_start_date -
                ADD_MONTHS(
                    PPF.DATE_OF_BIRTH,
                    TRUNC(MONTHS_BETWEEN(:p_effective_start_date, PPF.DATE_OF_BIRTH))
                )
            )
            || ' Days'
    END AGE,
 
    HL.MEANING NATIONALITY,
 
    (
        SELECT INITCAP(PP.FULL_NAME)
        FROM PER_PEOPLE_F PP
        WHERE PP.PERSON_ID = PAF.SUPERVISOR_ID
          AND SYSDATE BETWEEN PP.EFFECTIVE_START_DATE AND PP.EFFECTIVE_END_DATE
    ) SUP_NAME,
 
    PAST.USER_STATUS EMPLOYMENT_STATUS,
 
    TO_CHAR(ADD_MONTHS(PPF.DATE_OF_BIRTH, 720), 'DD-MON-YYYY') RETIREMENT_DATE
 
FROM PER_PEOPLE_F PPF
JOIN PER_ASSIGNMENTS_F PAF
    ON PPF.PERSON_ID = PAF.PERSON_ID
LEFT JOIN PER_GRADES PG
    ON PAF.GRADE_ID = PG.GRADE_ID
LEFT JOIN PER_ALL_POSITIONS PPS
    ON PAF.POSITION_ID = PPS.POSITION_ID
LEFT JOIN PER_JOBS PJ
    ON PAF.JOB_ID = PJ.JOB_ID
LEFT JOIN HR_LOOKUPS HL
    ON HL.LOOKUP_TYPE = 'NATIONALITY'
   AND HL.LOOKUP_CODE = PPF.NATIONALITY
JOIN PER_PERIODS_OF_SERVICE POS
    ON POS.PERSON_ID = PAF.PERSON_ID
LEFT JOIN PER_ASSIGNMENT_STATUS_TYPES PAST
    ON PAST.ASSIGNMENT_STATUS_TYPE_ID = PAF.ASSIGNMENT_STATUS_TYPE_ID
 
WHERE
    TRUNC(PAF.EFFECTIVE_START_DATE)
        BETWEEN POS.DATE_START
        AND NVL(POS.ACTUAL_TERMINATION_DATE, PAF.EFFECTIVE_START_DATE)
 
AND PAF.EFFECTIVE_START_DATE BETWEEN PPF.EFFECTIVE_START_DATE AND PPF.EFFECTIVE_END_DATE
 
AND PPF.PERSON_ID = NVL(:p_employee_number, PPF.PERSON_ID)
 
AND PAF.PAYROLL_ID = :p_payroll_id
 
AND PPF.CURRENT_EMPLOYEE_FLAG = 'Y'
 
AND TRUNC(MONTHS_BETWEEN(:p_effective_start_date, PPF.DATE_OF_BIRTH) / 12) >= :p_age
 
AND PAF.PRIMARY_FLAG = 'Y'
 
AND (
        :p_department IS NULL
        OR xxoa_hr.GET_PARENT_ORG(
            fnd_profile.VALUE('PER_BUSINESS_GROUP_ID'),
            paf.organization_id,
            'DEPT',
            'ID'
        ) = :p_department
    )
 
ORDER BY dept, section, LPAD(ppf.employee_number, 10);
